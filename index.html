<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شات الحب - تطبيق رومانسي للأزواج</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- إضافة Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #e91e63;
            --secondary-color: #c2185b;
            --accent-color: #f8bbd9;
            --light-color: #fce4ec;
            --dark-color: #880e4f;
            --bg-color: #fff5f8;
            --chat-bg: #ffffff;
            --user-message: #e91e63;
            --other-message: #f8bbd9;
            --gradient: linear-gradient(135deg, #e91e63, #f8bbd9);
            --highlight-color: #fff9c4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--dark-color);
            height: 100vh;
            overflow: hidden;
            background-image: linear-gradient(rgba(255, 245, 248, 0.9), rgba(255, 245, 248, 0.9)), url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%23e91e63" opacity="0.1" d="M50,30 C60,20 80,25 80,40 C80,55 65,60 50,70 C35,60 20,55 20,40 C20,25 40,20 50,30 Z"/></svg>');
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
            margin: 0 auto;
        }

        /* رأس التطبيق */
        .header {
            background: var(--gradient);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(233, 30, 99, 0.2);
            min-height: 60px;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="50" height="50" opacity="0.1"><path fill="%23ffffff" d="M50,30 C60,20 80,25 80,40 C80,55 65,60 50,70 C35,60 20,55 20,40 C20,25 40,20 50,30 Z"/></svg>');
        }

        .header h1 {
            font-size: 1.2rem;
            font-weight: 600;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary-color);
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* منطقة المحادثة */
        .chat-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* قائمة المستخدمين */
        .users-sidebar {
            width: 250px;
            background-color: white;
            border-left: 1px solid #ffcdd2;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            box-shadow: -2px 0 10px rgba(233, 30, 99, 0.1);
            flex-shrink: 0;
        }

        .users-header {
            padding: 12px 15px;
            background-color: var(--light-color);
            border-bottom: 1px solid #ffcdd2;
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .users-list {
            flex: 1;
            overflow-y: auto;
        }

        .user-item {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #fce4ec;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .user-item:hover {
            background-color: #fce4ec;
        }

        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4caf50;
        }

        .user-status.offline {
            background-color: #9e9e9e;
        }

        /* منطقة الرسائل */
        .messages-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--chat-bg);
            position: relative;
            min-width: 0;
        }

        .messages-header {
            padding: 12px 15px;
            background-color: white;
            border-bottom: 1px solid #ffcdd2;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: var(--dark-color);
            flex-shrink: 0;
        }

        .search-container {
            padding: 10px 15px;
            background-color: white;
            border-bottom: 1px solid #ffcdd2;
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ffcdd2;
            border-radius: 20px;
            outline: none;
            font-size: 0.9rem;
        }

        .search-input:focus {
            border-color: var(--primary-color);
        }

        .messages-container {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-color: var(--bg-color);
        }

        .message {
            max-width: 85%;
            padding: 10px 12px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            font-size: 0.95rem;
            animation: messageAppear 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            background-color: var(--user-message);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.other {
            align-self: flex-start;
            background-color: var(--other-message);
            color: var(--dark-color);
            border-bottom-left-radius: 5px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .message-actions {
            position: absolute;
            top: -8px;
            right: 8px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: none;
            padding: 4px;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action {
            margin: 0 4px;
            cursor: pointer;
            color: var(--dark-color);
            font-size: 0.8rem;
            transition: color 0.2s;
        }

        .message-action:hover {
            color: var(--primary-color);
        }

        .reply-indicator {
            background-color: rgba(255, 255, 255, 0.3);
            border-right: 3px solid var(--primary-color);
            padding: 6px 10px;
            border-radius: 8px;
            margin-bottom: 5px;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .file-attachment {
            margin-top: 8px;
            padding: 6px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
        }

        .file-attachment img {
            max-width: 200px;
            border-radius: 8px;
            cursor: pointer;
        }

        .file-attachment video {
            max-width: 250px;
            border-radius: 8px;
            cursor: pointer;
        }

        .gif-attachment {
            margin-top: 8px;
            border-radius: 8px;
            overflow: hidden;
        }

        .gif-attachment img {
            max-width: 200px;
            border-radius: 8px;
        }

        /* منطقة إدخال الرسالة - تم التصحيح */
        .input-area {
            padding: 12px 15px;
            background-color: white;
            border-top: 1px solid #ffcdd2;
            display: flex;
            gap: 8px;
            align-items: flex-end;
            position: relative;
            flex-shrink: 0;
            min-height: 70px;
        }

        .message-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ffcdd2;
            border-radius: 24px;
            outline: none;
            resize: none;
            height: 45px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
            min-width: 0;
        }

        .message-input:focus {
            border-color: var(--primary-color);
        }

        .action-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--gradient);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(233, 30, 99, 0.2);
            flex-shrink: 0;
        }

        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(233, 30, 99, 0.3);
        }

        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* شاشة تسجيل الدخول */
        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: var(--gradient);
            padding: 15px;
            position: relative;
            overflow: hidden;
        }

        .auth-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100" opacity="0.1"><path fill="%23ffffff" d="M50,30 C60,20 80,25 80,40 C80,55 65,60 50,70 C35,60 20,55 20,40 C20,25 40,20 50,30 Z"/></svg>');
        }

        .auth-box {
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 350px;
            position: relative;
            z-index: 1;
        }

        .auth-box h2 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--dark-color);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .quick-login {
            margin-top: 15px;
            text-align: center;
        }

        .quick-login button {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 25px;
            cursor: pointer;
            margin: 4px 0;
            width: 100%;
            font-size: 0.9rem;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(233, 30, 99, 0.2);
        }

        .quick-login button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(233, 30, 99, 0.3);
        }

        .hidden {
            display: none;
        }

        /* التكيف مع الشاشات الصغيرة - تم التصحيح */
        @media (max-width: 768px) {
            .users-sidebar {
                position: absolute;
                top: 60px;
                right: 0;
                bottom: 0;
                z-index: 100;
                transform: translateX(100%);
                width: 280px;
            }
            
            .users-sidebar.active {
                transform: translateX(0);
            }
            
            .message {
                max-width: 90%;
            }
            
            .emoji-picker, .gif-picker, .file-upload-container {
                width: 300px !important;
                right: 10px !important;
                bottom: 60px !important;
            }
            
            .header h1 {
                font-size: 1.1rem;
            }

            .input-area {
                padding: 10px 12px;
                gap: 6px;
                min-height: 65px;
                display: flex !important;
                visibility: visible !important;
            }

            .action-btn {
                width: 40px;
                height: 40px;
                font-size: 0.8rem;
                display: flex !important;
            }

            .message-input {
                height: 40px;
                font-size: 0.85rem;
                display: block !important;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 10px 12px;
            }
            
            .messages-container {
                padding: 10px;
            }
            
            .input-area {
                padding: 8px 10px;
                min-height: 60px;
                flex-wrap: nowrap;
            }
            
            .message {
                max-width: 95%;
                padding: 8px 10px;
            }
            
            .emoji-picker, .gif-picker, .file-upload-container {
                width: 280px !important;
                right: 5px !important;
            }

            .action-btn {
                width: 38px;
                height: 38px;
            }

            .users-sidebar {
                width: 100%;
            }
        }

        /* حل طارئ لإظهار الشريط السفلي في الهواتف */
        @media (max-width: 768px) {
            .input-area {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                height: auto !important;
                min-height: 70px !important;
                position: relative !important;
                background: white !important;
                z-index: 1000 !important;
            }
            
            .input-area * {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            .action-btn, .emoji-btn, .gif-btn {
                display: flex !important;
                visibility: visible !important;
                width: 40px !important;
                height: 40px !important;
                min-width: 40px !important;
            }
            
            .message-input {
                display: block !important;
                visibility: visible !important;
                flex: 1 !important;
            }
        }

        /* مؤشر الكتابة */
        .typing-indicator {
            padding: 4px 12px;
            font-style: italic;
            color: var(--dark-color);
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* تفاعلات الإيموجي */
        .message-reactions {
            display: flex;
            margin-top: 6px;
            gap: 4px;
            flex-wrap: wrap;
        }

        .reaction {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .reaction:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }

        .reaction-count {
            font-size: 0.65rem;
        }

        .reaction-picker {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            padding: 6px;
            display: none;
            z-index: 100;
        }

        .reaction-option {
            font-size: 1.3rem;
            padding: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .reaction-option:hover {
            transform: scale(1.2);
        }

        /* مكتبة الإيموجي */
        .emoji-btn, .gif-btn {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            padding: 4px;
            color: var(--primary-color);
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .emoji-btn:hover, .gif-btn:hover {
            transform: scale(1.1);
        }

        .emoji-picker, .gif-picker {
            position: absolute;
            bottom: 60px;
            right: 15px;
            width: 320px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            padding: 12px;
            z-index: 1000;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .emoji-category, .gif-category {
            margin-bottom: 8px;
        }

        .emoji-category h4, .gif-category h4 {
            margin-bottom: 6px;
            color: var(--dark-color);
            border-bottom: 1px solid #ffcdd2;
            padding-bottom: 4px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
        }

        .emoji {
            font-size: 1.3rem;
            cursor: pointer;
            text-align: center;
            padding: 4px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        .emoji:hover {
            background-color: #fce4ec;
        }

        /* مكتبة GIF */
        .gif-search {
            margin-bottom: 10px;
        }

        .gif-search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ffcdd2;
            border-radius: 20px;
            outline: none;
            font-size: 0.9rem;
        }

        .gif-search-input:focus {
            border-color: var(--primary-color);
        }

        .gif-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .gif-item {
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
            position: relative;
        }

        .gif-item:hover {
            transform: scale(1.03);
        }

        .gif-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }

        /* إشعارات */
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--gradient);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            display: none;
            font-size: 0.85rem;
            max-width: 300px;
        }

        /* زر عرض/إخفاء قائمة المستخدمين للجوال */
        .mobile-users-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .mobile-users-toggle {
                display: block;
            }
        }

        /* تأثيرات القلوب والإيموجي */
        .floating-emoji {
            position: fixed;
            pointer-events: none;
            z-index: 10000;
            font-size: 2.5rem;
            animation: floatDown 6s ease-in-out forwards;
            user-select: none;
            opacity: 1;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.9);
            filter: drop-shadow(0 0 5px rgba(233, 30, 99, 0.3));
        }

        @keyframes floatDown {
            0% {
                transform: translateY(-100px) scale(0.8) rotate(0deg);
                opacity: 1;
            }
            70% {
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) scale(1.2) rotate(360deg);
                opacity: 0;
            }
        }

        .emoji-rain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .emoji-drop {
            position: absolute;
            font-size: 2rem;
            animation: emojiRainFall 5s linear forwards;
            user-select: none;
            opacity: 1;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            filter: drop-shadow(0 0 3px rgba(233, 30, 99, 0.4));
        }

        @keyframes emojiRainFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            80% {
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .heart {
            position: absolute;
            pointer-events: none;
            opacity: 0.8;
            animation: float 3s ease-in-out forwards;
        }

        @keyframes float {
            0% {
                transform: translateY(0) scale(1);
                opacity: 0.8;
            }
            100% {
                transform: translateY(-100px) scale(0.5);
                opacity: 0;
            }
        }

        /* تأثيرات الفقاعات */
        .bubble {
            position: absolute;
            background: rgba(233, 30, 99, 0.1);
            border-radius: 50%;
            pointer-events: none;
            animation: bubble 2s ease-in-out forwards;
        }

        @keyframes bubble {
            0% {
                transform: scale(0);
                opacity: 0.8;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* ثيمات */
        .theme-selector {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }

        .theme-btn {
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .theme-options {
            position: absolute;
            top: 50px;
            left: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
        }

        .theme-option {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: right;
            transition: background-color 0.2s;
        }

        .theme-option:hover {
            background-color: #fce4ec;
        }

        /* خلفية رومانسية */
        .romantic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(233, 30, 99, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(248, 187, 217, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(192, 24, 91, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* تمييز النص في البحث */
        .highlight {
            background-color: var(--highlight-color);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
        }

        .message.highlighted {
            animation: pulseHighlight 2s ease-in-out;
            border: 2px solid var(--highlight-color);
        }

        @keyframes pulseHighlight {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 249, 196, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 249, 196, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 249, 196, 0);
            }
        }

        /* أنماط رفع الملفات */
        .file-upload-container {
            position: absolute;
            bottom: 70px;
            right: 15px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1000;
            display: none;
            min-width: 200px;
        }

        .upload-option {
            padding: 10px 15px;
            border: none;
            background: none;
            text-align: right;
            width: 100%;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--dark-color);
        }

        .upload-option:hover {
            background-color: #fce4ec;
        }

        .file-input {
            display: none;
        }

        .upload-progress {
            width: 100%;
            height: 4px;
            background-color: #f0f0f0;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
            display: none;
        }

        .upload-progress-bar {
            height: 100%;
            background: var(--gradient);
            width: 0%;
            transition: width 0.3s ease;
        }

        .preview-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .preview-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .preview-image {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 10px;
        }

        .preview-video {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 10px;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .close-preview {
            position: absolute;
            top: 10px;
            left: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark-color);
        }
    </style>
</head>
<body>
    <!-- خلفية رومانسية -->
    <div class="romantic-bg"></div>

    <!-- منطقة تأثيرات الإيموجي -->
    <div class="emoji-rain" id="emojiRain"></div>

    <!-- إشعارات -->
    <div class="notification" id="notification"></div>

    <!-- ثيمات -->
    <div class="theme-selector">
        <button class="theme-btn" id="themeBtn">
            <i class="fas fa-palette"></i>
        </button>
        <div class="theme-options" id="themeOptions">
            <button class="theme-option" data-theme="romantic">رومانسي 💖</button>
            <button class="theme-option" data-theme="classic">كلاسيكي 💕</button>
            <button class="theme-option" data-theme="elegant">أنيق 🌹</button>
        </div>
    </div>

    <!-- شاشة تسجيل الدخول -->
    <div id="authScreen" class="auth-container">
        <div class="auth-box">
            <h2><i class="fas fa-heart"></i> شات الحب</h2>
            <p style="text-align: center; margin-bottom: 15px; color: var(--dark-color); font-size: 0.9rem;">
                اختر شخصيتك للدخول إلى عالم الرومانسية
            </p>
            
            <div class="quick-login">
                <button id="loginUser1">
                    <i class="fas fa-heart"></i> الدخول كـ أحمد
                </button>
                <button id="loginUser2">
                    <i class="fas fa-heart"></i> الدخول كـ سارة
                </button>
            </div>
            
            <div style="margin-top: 15px; padding: 12px; background-color: #fce4ec; border-radius: 10px;">
                <h4 style="margin-bottom: 8px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px;"><i class="fas fa-info-circle"></i> معلومات التطبيق:</h4>
                <p style="font-size: 0.8rem; color: var(--dark-color);">
                    تطبيق شات رومانسي مخصص للأزواج. استمتع بتجربة فريدة مليئة بالمشاعر الجميلة.
                </p>
            </div>
        </div>
    </div>

    <!-- تطبيق الشات -->
    <div id="chatApp" class="container hidden">
        <!-- رأس التطبيق -->
        <div class="header">
            <div style="display: flex; align-items: center;">
                <button class="mobile-users-toggle" id="mobileUsersToggle">
                    <i class="fas fa-users"></i>
                </button>
                <h1><i class="fas fa-heart"></i> شات الحب</h1>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">❤️</div>
                <span id="userName">حبيبي/حبيبتي</span>
                <button id="logoutBtn" class="action-btn" style="background-color: transparent; color: white; box-shadow: none;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- منطقة المحادثة -->
        <div class="chat-container">
            <!-- قائمة المستخدمين -->
            <div class="users-sidebar" id="usersSidebar">
                <div class="users-header">
                    <i class="fas fa-heart"></i> الأحبة المتصلون
                </div>
                <div class="users-list" id="usersList">
                    <!-- سيتم ملء قائمة المستخدمين ديناميكيًا -->
                </div>
            </div>

            <!-- منطقة الرسائل -->
            <div class="messages-area">
                <div class="messages-header">
                    <span>محادثة الحب 💕</span>
                    <span id="onlineCount">2 متصلون</span>
                </div>
                
                <!-- شريط البحث -->
                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="ابحث في الرسائل...">
                    <button class="action-btn" id="searchBtn" style="width: 40px; height: 40px;">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <!-- سيتم ملء الرسائل ديناميكيًا -->
                </div>
                <div class="typing-indicator hidden" id="typingIndicator"></div>
                
                <!-- مكتبة الإيموجي -->
                <div class="emoji-picker" id="emojiPicker">
                    <div class="emoji-category">
                        <h4><i class="fas fa-heart"></i> رومانسي</h4>
                        <div class="emoji-grid">
                            <div class="emoji">💖</div>
                            <div class="emoji">💕</div>
                            <div class="emoji">💗</div>
                            <div class="emoji">💓</div>
                            <div class="emoji">💞</div>
                            <div class="emoji">💘</div>
                            <div class="emoji">❤️</div>
                            <div class="emoji">🧡</div>
                            <div class="emoji">💛</div>
                            <div class="emoji">💚</div>
                            <div class="emoji">💙</div>
                            <div class="emoji">💜</div>
                            <div class="emoji">🤎</div>
                            <div class="emoji">🖤</div>
                            <div class="emoji">🤍</div>
                            <div class="emoji">💋</div>
                            <div class="emoji">😘</div>
                            <div class="emoji">🥰</div>
                            <div class="emoji">😍</div>
                            <div class="emoji">❤️‍🔥</div>
                            <div class="emoji">❤️‍🩹</div>
                            <div class="emoji">💐</div>
                            <div class="emoji">🌹</div>
                            <div class="emoji">🥀</div>
                        </div>
                    </div>
                    <div class="emoji-category">
                        <h4><i class="fas fa-smile"></i> مشاعر</h4>
                        <div class="emoji-grid">
                            <div class="emoji">😊</div>
                            <div class="emoji">😇</div>
                            <div class="emoji">🙂</div>
                            <div class="emoji">🙃</div>
                            <div class="emoji">😉</div>
                            <div class="emoji">😌</div>
                            <div class="emoji">😋</div>
                            <div class="emoji">😛</div>
                            <div class="emoji">😝</div>
                            <div class="emoji">😜</div>
                            <div class="emoji">🤪</div>
                            <div class="emoji">😎</div>
                            <div class="emoji">🤩</div>
                            <div class="emoji">🥳</div>
                            <div class="emoji">😏</div>
                            <div class="emoji">😒</div>
                            <div class="emoji">😔</div>
                            <div class="emoji">😢</div>
                            <div class="emoji">😭</div>
                            <div class="emoji">😡</div>
                            <div class="emoji">🥺</div>
                            <div class="emoji">🤗</div>
                            <div class="emoji">🤭</div>
                            <div class="emoji">🫣</div>
                        </div>
                    </div>
                </div>
                
                <!-- مكتبة GIF -->
                <div class="gif-picker" id="gifPicker">
                    <div class="gif-search">
                        <input type="text" class="gif-search-input" id="gifSearchInput" placeholder="ابحث عن GIF رومانسي...">
                    </div>
                    <div class="gif-category">
                        <h4><i class="fas fa-heart"></i> رومانسي</h4>
                        <div class="gif-grid" id="gifGrid">
                            <!-- سيتم ملء الـ GIFs ديناميكيًا -->
                        </div>
                    </div>
                </div>
                
                <!-- حاوية رفع الملفات -->
                <div class="file-upload-container" id="fileUploadContainer">
                    <button class="upload-option" onclick="openFilePicker('image')">
                        <i class="fas fa-image"></i> صورة
                    </button>
                    <button class="upload-option" onclick="openFilePicker('video')">
                        <i class="fas fa-video"></i> فيديو
                    </button>
                    <button class="upload-option" onclick="openFilePicker('file')">
                        <i class="fas fa-file"></i> ملف
                    </button>
                    <div class="upload-progress" id="uploadProgress">
                        <div class="upload-progress-bar" id="uploadProgressBar"></div>
                    </div>
                </div>

                <!-- مدخلات الملفات المخفية -->
                <input type="file" id="imageInput" class="file-input" accept="image/*" multiple>
                <input type="file" id="videoInput" class="file-input" accept="video/*">
                <input type="file" id="fileInput" class="file-input" accept="*/*">

                <!-- حاوية معاينة الملفات -->
                <div class="preview-container" id="previewContainer">
                    <div class="preview-content">
                        <button class="close-preview" id="closePreview">
                            <i class="fas fa-times"></i>
                        </button>
                        <img class="preview-image" id="previewImage" style="display: none;">
                        <video class="preview-video" id="previewVideo" controls style="display: none;"></video>
                        <div class="preview-actions">
                            <button class="action-btn" id="sendFileBtn" style="display: none;">
                                <i class="fas fa-paper-plane"></i> إرسال
                            </button>
                            <button class="action-btn" id="cancelFileBtn" style="background: #6c757d;">
                                <i class="fas fa-times"></i> إلغاء
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <button class="action-btn" id="attachBtn">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="gif-btn" id="gifBtn">
                        <i class="fas fa-film"></i>
                    </button>
                    <button class="emoji-btn" id="emojiBtn">
                        <i class="fas fa-smile"></i>
                    </button>
                    <input type="text" class="message-input" id="messageInput" placeholder="اكتب رسالة حب...">
                    <button class="action-btn" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button class="action-btn" id="kissBtn" style="background: #ff6b95;">
                        <i class="fas fa-kiss-wink-heart"></i>
                    </button>
                    <button class="action-btn" id="heartbeatBtn" style="background: #ff4757;">
                        <i class="fas fa-heartbeat"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ⚙️ إعدادات Cloudinary
        const CLOUDINARY_CLOUD_NAME = 'dopzq8owd';
        const CLOUDINARY_UPLOAD_PRESET = 'lover_chat';

        // 🔥 إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDy9jmys9AcELdM7mdpySolC7JDyWr8nY0",
            authDomain: "lover-chat-523fa.firebaseapp.com",
            databaseURL: "https://lover-chat-523fa-default-rtdb.firebaseio.com",
            projectId: "lover-chat-523fa",
            storageBucket: "lover-chat-523fa.firebasestorage.app",
            messagingSenderId: "377312103297",
            appId: "1:377312103297:web:8b23979517c3b69d34f680",
            measurementId: "G-N42BMX8SGJ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 🔊 مكتبة الأصوات - الملفات مباشرة بدون مجلد
        const soundLibrary = {
            send: 'send.mp3',
            kiss: 'kiss.mp3',
            heartbeat: 'heartbeat.mp3',
            emoji: 'emoji.mp3',
            reaction: 'reaction.mp3',
            magic: 'magic.mp3',
            notification: 'notification.mp3'
        };

        // 👥 بيانات التطبيق
        const mockUsers = {
            user1: {
                id: 'user1',
                name: 'أحمد',
                email: 'ahmed@example.com',
                avatar: '❤️'
            },
            user2: {
                id: 'user2',
                name: 'سارة',
                email: 'sara@example.com',
                avatar: '💕'
            }
        };

        // 💾 تخزين محلي للبيانات
        let messages = [];
        let users = [];
        let currentUser = null;
        let currentFileToUpload = null;
        let currentFileType = null;
        let typingUsers = [];
        let audioEnabled = false;

        // 🔊 مشغل الأصوات
        function playSound(soundName) {
            if (!audioEnabled) return;
            
            const soundPath = soundLibrary[soundName];
            if (soundPath) {
                const audio = new Audio(soundPath);
                audio.volume = 0.7;
                audio.play().catch(e => console.log('تعذر تشغيل الصوت:', e));
            }
        }

        // 🔗 عناصر DOM
        const authScreen = document.getElementById('authScreen');
        const chatApp = document.getElementById('chatApp');
        const loginUser1 = document.getElementById('loginUser1');
        const loginUser2 = document.getElementById('loginUser2');
        const logoutBtn = document.getElementById('logoutBtn');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const usersList = document.getElementById('usersList');
        const usersSidebar = document.getElementById('usersSidebar');
        const mobileUsersToggle = document.getElementById('mobileUsersToggle');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const attachBtn = document.getElementById('attachBtn');
        const emojiBtn = document.getElementById('emojiBtn');
        const gifBtn = document.getElementById('gifBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const gifPicker = document.getElementById('gifPicker');
        const gifSearchInput = document.getElementById('gifSearchInput');
        const gifGrid = document.getElementById('gifGrid');
        const onlineCount = document.getElementById('onlineCount');
        const typingIndicator = document.getElementById('typingIndicator');
        const notification = document.getElementById('notification');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const themeBtn = document.getElementById('themeBtn');
        const themeOptions = document.getElementById('themeOptions');
        const emojiRain = document.getElementById('emojiRain');
        const kissBtn = document.getElementById('kissBtn');
        const heartbeatBtn = document.getElementById('heartbeatBtn');

        // 📁 عناصر رفع الملفات
        const fileUploadContainer = document.getElementById('fileUploadContainer');
        const imageInput = document.getElementById('imageInput');
        const videoInput = document.getElementById('videoInput');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const previewVideo = document.getElementById('previewVideo');
        const closePreview = document.getElementById('closePreview');
        const sendFileBtn = document.getElementById('sendFileBtn');
        const cancelFileBtn = document.getElementById('cancelFileBtn');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');

        // 🔊 تفعيل الصوت
        function enableAudio() {
            if (!audioEnabled) {
                audioEnabled = true;
                showNotification('تم تفعيل الصوت في التطبيق 🎵');
            }
        }

        document.addEventListener('click', enableAudio);
        document.addEventListener('touchstart', enableAudio);

        // 🔐 تسجيل الدخول - تم التصحيح
        loginUser1.addEventListener('click', function() {
            enableAudio();
            loginUser(mockUsers.user1);
        });

        loginUser2.addEventListener('click', function() {
            enableAudio();
            loginUser(mockUsers.user2);
        });

        // 🚪 تسجيل الخروج
        logoutBtn.addEventListener('click', function() {
            if (currentUser) {
                db.collection('users').doc(currentUser.id).update({
                    isOnline: false,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            currentUser = null;
            chatApp.classList.add('hidden');
            authScreen.classList.remove('hidden');
        });

        // 📱 تبديل قائمة المستخدمين
        mobileUsersToggle.addEventListener('click', function() {
            usersSidebar.classList.toggle('active');
        });

        // 👤 تسجيل الدخول
        function loginUser(user) {
            currentUser = user;
            
            // تحديث حالة المستخدم في Firebase
            db.collection('users').doc(user.id).set({
                name: user.name,
                avatar: user.avatar,
                isOnline: true,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            authScreen.classList.add('hidden');
            chatApp.classList.remove('hidden');
            
            userAvatar.textContent = user.avatar;
            userName.textContent = user.name;
            
            loadMessages();
            loadUsers();
            setupRealtimeListeners();
            
            // تم إزالة playSound('join') لإزالة الأغنية المزعجة
        }

        // 📡 إعداد المستمعين للتحديثات
        function setupRealtimeListeners() {
            // الاستماع للرسائل الجديدة
            db.collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(function(snapshot) {
                    messages = [];
                    snapshot.forEach(function(doc) {
                        messages.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    loadMessages();
                });

            // الاستماع لتحديثات المستخدمين
            db.collection('users')
                .onSnapshot(function(snapshot) {
                    users = [];
                    snapshot.forEach(function(doc) {
                        users.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    loadUsers();
                });
        }

        // 📨 تحميل الرسائل
        function loadMessages() {
            messagesContainer.innerHTML = '';
            
            messages
                .sort(function(a, b) { return a.timestamp - b.timestamp; })
                .forEach(function(message) {
                    displayMessage(message);
                });
            scrollToBottom();
        }

        // 💬 عرض الرسالة
        function displayMessage(message, isSearchResult = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.senderId === currentUser.id ? 'user' : 'other'}`;
            messageDiv.dataset.id = message.id;
            
            let messageText = message.text;
            
            let messageContent = `
                <div class="message-header">
                    <span>${message.senderName}</span>
                    <span>${formatTime(message.timestamp?.toDate())}</span>
                </div>
            `;
            
            if (message.replyTo) {
                messageContent += `
                    <div class="reply-indicator">
                        رد على: ${message.replyTo.text.substring(0, 50)}${message.replyTo.text.length > 50 ? '...' : ''}
                    </div>
                `;
            }
            
            messageContent += `<div class="message-text">${messageText}</div>`;
            
            // عرض المرفقات
            if (message.fileUrl) {
                if (message.fileType === 'image') {
                    messageContent += `
                        <div class="file-attachment">
                            <img src="${message.fileUrl}" alt="صورة مرفقة" onclick="previewFile('${message.fileUrl}', 'image')">
                            <div style="font-size: 0.8rem; margin-top: 5px;">${message.fileName || 'صورة'}</div>
                        </div>
                    `;
                } else if (message.fileType === 'video') {
                    messageContent += `
                        <div class="file-attachment">
                            <video controls style="max-width: 250px; border-radius: 8px;" onclick="previewFile('${message.fileUrl}', 'video')">
                                <source src="${message.fileUrl}" type="video/mp4">
                                متصفحك لا يدعم تشغيل الفيديو
                            </video>
                            <div style="font-size: 0.8rem; margin-top: 5px;">${message.fileName || 'فيديو'}</div>
                        </div>
                    `;
                } else {
                    messageContent += `
                        <div class="file-attachment">
                            <i class="fas fa-file"></i>
                            <a href="${message.fileUrl}" target="_blank" download="${message.fileName}">
                                ${message.fileName || 'ملف مرفق'}
                            </a>
                        </div>
                    `;
                }
            }
            
            if (message.gifUrl) {
                messageContent += `
                    <div class="gif-attachment">
                        <img src="${message.gifUrl}" alt="GIF">
                    </div>
                `;
            }
            
            // تفاعلات الإيموجي
            if (message.reactions && Object.keys(message.reactions).length > 0) {
                messageContent += `<div class="message-reactions">`;
                for (const [emoji, users] of Object.entries(message.reactions)) {
                    messageContent += `
                        <div class="reaction" onclick="addReaction('${message.id}', '${emoji}')">
                            <span>${emoji}</span>
                            <span class="reaction-count">${users.length}</span>
                        </div>
                    `;
                }
                messageContent += `</div>`;
            }
            
            messageContent += `
                <div class="message-actions">
                    <span class="message-action" onclick="showReactionPicker('${message.id}')">
                        <i class="fas fa-heart"></i>
                    </span>
                    <span class="message-action" onclick="replyToMessage('${message.id}')">
                        <i class="fas fa-reply"></i>
                    </span>
                    ${message.senderId === currentUser.id ? `
                        <span class="message-action" onclick="editMessage('${message.id}')">
                            <i class="fas fa-edit"></i>
                        </span>
                        <span class="message-action" onclick="deleteMessage('${message.id}')">
                            <i class="fas fa-trash"></i>
                        </span>
                    ` : ''}
                </div>
            `;
            
            messageDiv.innerHTML = messageContent;
            messagesContainer.appendChild(messageDiv);
            
            // منتقي التفاعلات
            const reactionPicker = document.createElement('div');
            reactionPicker.className = 'reaction-picker';
            reactionPicker.id = `reaction-picker-${message.id}`;
            reactionPicker.innerHTML = `
                <span class="reaction-option" onclick="addReaction('${message.id}', '💖')">💖</span>
                <span class="reaction-option" onclick="addReaction('${message.id}', '❤️')">❤️</span>
                <span class="reaction-option" onclick="addReaction('${message.id}', '😘')">😘</span>
                <span class="reaction-option" onclick="addReaction('${message.id}', '🥰')">🥰</span>
                <span class="reaction-option" onclick="addReaction('${message.id}', '🌹')">🌹</span>
                <span class="reaction-option" onclick="addReaction('${message.id}', '💕')">💕</span>
            `;
            messageDiv.appendChild(reactionPicker);
        }

        // 📤 إرسال رسالة - تم التحديث
        function sendMessage() {
            const text = messageInput.value.trim();
            if (text === '') return;
            
            db.collection('messages').add({
                text: text,
                senderId: currentUser.id,
                senderName: currentUser.name,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                reactions: {}
            });
            
            messageInput.value = '';
            createBubbles(3);
            
            const emojiMatches = text.match(/\p{Emoji}/gu);
            
            if (emojiMatches) {
                // رسالة تحتوي على إيموجي: emoji فقط + إيموجيات طائرة
                playSound('emoji');
                setTimeout(function() {
                    createFloatingEmojis(emojiMatches, 15);
                }, 300);
            } else {
                // رسالة عادية: send فقط
                playSound('send');
            }
            
            if (text.includes('حب') || text.includes('حبي') || text.includes('عشق') || text.includes('قلبي')) {
                createHearts(5);
            }
        }

        // ☁️ رفع ملف إلى Cloudinary
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            
            try {
                uploadProgress.style.display = 'block';
                uploadProgressBar.style.width = '30%';

                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, {
                    method: 'POST',
                    body: formData
                });

                uploadProgressBar.style.width = '70%';

                const data = await response.json();
                
                uploadProgressBar.style.width = '100%';
                
                if (data.secure_url) {
                    showNotification('✅ تم رفع الملف بنجاح!');
                    return data.secure_url;
                } else {
                    throw new Error('فشل في رفع الملف');
                }
            } catch (error) {
                console.error('خطأ في رفع الملف:', error);
                showNotification('❌ فشل في رفع الملف');
                return null;
            } finally {
                setTimeout(function() {
                    uploadProgress.style.display = 'none';
                    uploadProgressBar.style.width = '0%';
                }, 1000);
            }
        }

        // 📎 إرسال ملف
        sendFileBtn.addEventListener('click', async function() {
            if (!currentFileToUpload) return;

            const fileUrl = await uploadToCloudinary(currentFileToUpload);

            if (fileUrl) {
                await db.collection('messages').add({
                    text: '',
                    senderId: currentUser.id,
                    senderName: currentUser.name,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    fileUrl: fileUrl,
                    fileType: currentFileType,
                    fileName: currentFileToUpload.name,
                    reactions: {}
                });

                closeFilePreview();
                showNotification('✅ تم إرسال الملف بنجاح!');
                playSound('send'); // صوت send للملفات فقط
                createBubbles(2);
            }
        });

        // 👥 تحميل المستخدمين
        function loadUsers() {
            usersList.innerHTML = '';
            let onlineUsers = 0;
            
            users.forEach(function(user) {
                if (user.id !== currentUser.id) {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    
                    const lastSeen = user.lastSeen ? user.lastSeen.toDate() : new Date();
                    const isOnline = user.isOnline && (new Date() - lastSeen < 300000);
                    
                    userItem.innerHTML = `
                        <div class="user-status ${isOnline ? '' : 'offline'}"></div>
                        <div class="user-avatar">${user.avatar}</div>
                        <div class="user-details">
                            <div class="user-name">${user.name}</div>
                            <div class="user-status-text">${isOnline ? 'متصل/ة' : 'غير متصل/ة'}</div>
                        </div>
                    `;
                    usersList.appendChild(userItem);
                }
                
                if (user.isOnline) onlineUsers++;
            });
            
            onlineCount.textContent = `${onlineUsers} متصلون`;
        }

        // ⏰ تنسيق الوقت
        function formatTime(timestamp) {
            if (!timestamp) return '';
            return timestamp.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        }

        // 🔔 الإشعارات
        function showNotification(text) {
            notification.textContent = text;
            notification.style.display = 'block';
            setTimeout(function() {
                notification.style.display = 'none';
            }, 3000);
        }

        // ✨ التأثيرات البصرية
        function createFloatingEmojis(emojis, count) {
            // تم إزالة playSound('magic') من هنا - سيتم تشغيله بعد تأخير
            for (let i = 0; i < count; i++) {
                setTimeout(function() {
                    const emoji = document.createElement('div');
                    emoji.className = 'floating-emoji';
                    emoji.innerHTML = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.style.left = Math.random() * 100 + 'vw';
                    emoji.style.top = '-50px';
                    emoji.style.fontSize = (Math.random() * 15 + 30) + 'px';
                    emoji.style.animationDuration = (Math.random() * 2 + 4) + 's';
                    document.body.appendChild(emoji);
                    
                    setTimeout(function() {
                        if (emoji.parentNode) {
                            emoji.remove();
                        }
                    }, 6000);
                }, i * 200);
            }
        }

        function createHearts(count) {
            for (let i = 0; i < count; i++) {
                setTimeout(function() {
                    const heart = document.createElement('div');
                    heart.className = 'heart';
                    heart.innerHTML = '💖';
                    heart.style.left = Math.random() * 100 + 'vw';
                    heart.style.fontSize = (Math.random() * 20 + 20) + 'px';
                    document.body.appendChild(heart);
                    
                    setTimeout(function() {
                        if (heart.parentNode) {
                            heart.remove();
                        }
                    }, 3000);
                }, i * 200);
            }
        }

        function createBubbles(count) {
            for (let i = 0; i < count; i++) {
                setTimeout(function() {
                    const bubble = document.createElement('div');
                    bubble.className = 'bubble';
                    bubble.style.left = Math.random() * 100 + 'vw';
                    bubble.style.top = '80vh';
                    bubble.style.width = bubble.style.height = (Math.random() * 50 + 20) + 'px';
                    document.body.appendChild(bubble);
                    
                    setTimeout(function() {
                        if (bubble.parentNode) {
                            bubble.remove();
                        }
                    }, 2000);
                }, i * 100);
            }
        }

        // 📎 إدارة الملفات
        function openFilePicker(type) {
            fileUploadContainer.style.display = 'none';
            
            switch(type) {
                case 'image':
                    imageInput.click();
                    break;
                case 'video':
                    videoInput.click();
                    break;
                case 'file':
                    fileInput.click();
                    break;
            }
        }

        imageInput.addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length > 0) {
                if (files.length === 1) {
                    showPreview(files[0], 'image');
                } else {
                    uploadMultipleFiles(files, 'image');
                }
            }
        });

        videoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                showPreview(file, 'video');
            }
        });

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                showPreview(file, 'file');
            }
        });

        function showPreview(file, type) {
            currentFileToUpload = file;
            currentFileType = type;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                if (type === 'image') {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    previewVideo.style.display = 'none';
                } else if (type === 'video') {
                    previewVideo.src = e.target.result;
                    previewVideo.style.display = 'block';
                    previewImage.style.display = 'none';
                } else {
                    previewImage.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23e91e63"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><text x="12" y="18" text-anchor="middle" font-size="8" fill="white">' + getFileExtension(file.name) + '</text></svg>';
                    previewImage.style.display = 'block';
                    previewVideo.style.display = 'none';
                }
                
                sendFileBtn.style.display = 'block';
                previewContainer.style.display = 'flex';
            };
            
            reader.readAsDataURL(file);
        }

        function getFileExtension(filename) {
            return filename.split('.').pop().toUpperCase();
        }

        function closeFilePreview() {
            previewContainer.style.display = 'none';
            currentFileToUpload = null;
            currentFileType = null;
            imageInput.value = '';
            videoInput.value = '';
            fileInput.value = '';
        }

        async function uploadMultipleFiles(files, type) {
            showNotification(`📤 جاري رفع ${files.length} ملف...`);
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileUrl = await uploadToCloudinary(file);
                if (fileUrl) {
                    await db.collection('messages').add({
                        text: '',
                        senderId: currentUser.id,
                        senderName: currentUser.name,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        fileUrl: fileUrl,
                        fileType: type,
                        fileName: file.name,
                        reactions: {}
                    });
                }
            }
            
            showNotification('✅ تم رفع جميع الملفات بنجاح!');
        }

        function previewFile(fileUrl, fileType) {
            if (fileType === 'image') {
                previewImage.src = fileUrl;
                previewImage.style.display = 'block';
                previewVideo.style.display = 'none';
            } else if (fileType === 'video') {
                previewVideo.src = fileUrl;
                previewVideo.style.display = 'block';
                previewImage.style.display = 'none';
            }
            
            sendFileBtn.style.display = 'none';
            previewContainer.style.display = 'flex';
        }

        // 🔼 التمرير للأسفل
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ❤️ التفاعلات
        function addReaction(messageId, emoji) {
            const messageRef = db.collection('messages').doc(messageId);
            
            db.runTransaction(async function(transaction) {
                const messageDoc = await transaction.get(messageRef);
                if (!messageDoc.exists) return;
                
                const messageData = messageDoc.data();
                const reactions = messageData.reactions || {};
                
                if (!reactions[emoji]) {
                    reactions[emoji] = [];
                }
                
                const userIndex = reactions[emoji].indexOf(currentUser.id);
                if (userIndex > -1) {
                    reactions[emoji].splice(userIndex, 1);
                    if (reactions[emoji].length === 0) {
                        delete reactions[emoji];
                    }
                } else {
                    reactions[emoji].push(currentUser.id);
                }
                
                transaction.update(messageRef, { reactions });
            }).then(function() {
                playSound('reaction');
                setTimeout(function() {
                    playSound('magic');
                    createFloatingEmojis([emoji], 8);
                }, 300);
                
                const reactionPicker = document.getElementById(`reaction-picker-${messageId}`);
                if (reactionPicker) {
                    reactionPicker.style.display = 'none';
                }
            });
        }

        function showReactionPicker(messageId) {
            document.querySelectorAll('.reaction-picker').forEach(function(picker) {
                picker.style.display = 'none';
            });
            
            const reactionPicker = document.getElementById(`reaction-picker-${messageId}`);
            if (reactionPicker) {
                reactionPicker.style.display = 'flex';
            }
        }

        // 🗑️ إدارة الرسائل
        function deleteMessage(messageId) {
            if (confirm('هل أنت متأكد من حذف هذه الرسالة؟')) {
                db.collection('messages').doc(messageId).delete();
            }
        }

        function editMessage(messageId) {
            const message = messages.find(function(m) { return m.id === messageId; });
            if (message) {
                const newText = prompt('عدل رسالتك:', message.text);
                if (newText !== null && newText.trim() !== '') {
                    db.collection('messages').doc(messageId).update({
                        text: newText
                    });
                }
            }
        }

        function replyToMessage(messageId) {
            const message = messages.find(function(m) { return m.id === messageId; });
            if (message) {
                messageInput.value = `رد على ${message.senderName}: ${message.text.substring(0, 30)}... `;
                messageInput.focus();
            }
        }

        // 🎨 الثيمات
        themeBtn.addEventListener('click', function() {
            themeOptions.style.display = themeOptions.style.display === 'flex' ? 'none' : 'flex';
        });

        document.querySelectorAll('.theme-option').forEach(function(option) {
            option.addEventListener('click', function() {
                const theme = option.dataset.theme;
                applyTheme(theme);
                themeOptions.style.display = 'none';
                showNotification(`تم تطبيق الثيم ${option.textContent}`);
            });
        });

        function applyTheme(theme) {
            document.documentElement.style.setProperty('--primary-color', '#e91e63');
            document.documentElement.style.setProperty('--secondary-color', '#c2185b');
            document.documentElement.style.setProperty('--accent-color', '#f8bbd9');
            document.documentElement.style.setProperty('--light-color', '#fce4ec');
            document.documentElement.style.setProperty('--dark-color', '#880e4f');
            document.documentElement.style.setProperty('--bg-color', '#fff5f8');
            document.documentElement.style.setProperty('--chat-bg', '#ffffff');
            document.documentElement.style.setProperty('--user-message', '#e91e63');
            document.documentElement.style.setProperty('--other-message', '#f8bbd9');
            document.documentElement.style.setProperty('--gradient', 'linear-gradient(135deg, #e91e63, #f8bbd9)');

            if (theme === 'classic') {
                document.documentElement.style.setProperty('--primary-color', '#d81b60');
                document.documentElement.style.setProperty('--secondary-color', '#ad1457');
                document.documentElement.style.setProperty('--accent-color', '#f48fb1');
                document.documentElement.style.setProperty('--gradient', 'linear-gradient(135deg, #d81b60, #f48fb1)');
            } else if (theme === 'elegant') {
                document.documentElement.style.setProperty('--primary-color', '#c2185b');
                document.documentElement.style.setProperty('--secondary-color', '#880e4f');
                document.documentElement.style.setProperty('--accent-color', '#f8bbd9');
                document.documentElement.style.setProperty('--gradient', 'linear-gradient(135deg, #c2185b, #f8bbd9)');
            }
        }

        // 🔍 البحث
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        function performSearch() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            if (searchTerm === '') {
                loadMessages();
                return;
            }

            const filteredMessages = messages.filter(function(message) { 
                return message.text.toLowerCase().includes(searchTerm);
            });

            if (filteredMessages.length === 0) {
                showNotification('لم يتم العثور على نتائج');
                return;
            }

            messagesContainer.innerHTML = '';
            filteredMessages.forEach(function(message) {
                displayMessage(message, true);
            });

            if (filteredMessages.length > 0) {
                const firstMessage = document.querySelector('.message');
                if (firstMessage) {
                    firstMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstMessage.classList.add('highlighted');
                    
                    setTimeout(function() {
                        firstMessage.classList.remove('highlighted');
                    }, 3000);
                }
            }
        }

        // 📌 إضافة الإيموجي - تم التحديث
        document.querySelectorAll('.emoji').forEach(function(emojiElement) {
            emojiElement.addEventListener('click', function() {
                messageInput.value += emojiElement.textContent;
                messageInput.focus();
                // تم إزالة playSound('emoji') و createFloatingEmojis من هنا
            });
        });

        // 💋 الأزرار الخاصة - تم التحديث
        kissBtn.addEventListener('click', function() {
            playSound('kiss');
            setTimeout(function() {
                playSound('magic');
                createFloatingEmojis(['💋', '😘', '💋'], 10);
            }, 500);
            showNotification('💋 قبلة حارة!');
        });

        heartbeatBtn.addEventListener('click', function() {
            playSound('heartbeat');
            setTimeout(function() {
                playSound('magic');
                createHearts(8);
            }, 500);
            showNotification('💓 دقات قلبي لك!');
        });

        // 🎬 مكتبة GIF
        gifBtn.addEventListener('click', function() {
            gifPicker.style.display = gifPicker.style.display === 'block' ? 'none' : 'block';
            emojiPicker.style.display = 'none';
            fileUploadContainer.style.display = 'none';
            loadRomanticGifs();
        });

        function loadRomanticGifs(searchTerm = 'romance') {
            const romanticGifs = [
                'https://media.giphy.com/media/l0HlRnAWXxn0MhKLK/giphy.gif',
                'https://media.giphy.com/media/3o7aD2d7hy9ktXNDP2/giphy.gif',
                'https://media.giphy.com/media/l41lZ2sJreWUvX3UY/giphy.gif',
                'https://media.giphy.com/media/3o72FfM5HJydzafgUE/giphy.gif',
                'https://media.giphy.com/media/l4FGI8GoTL7N4DsyI/giphy.gif',
                'https://media.giphy.com/media/3o7aCTPPm4OHfRLSH6/giphy.gif'
            ];
            
            gifGrid.innerHTML = '';
            romanticGifs.forEach(function(gifUrl) {
                const gifItem = document.createElement('div');
                gifItem.className = 'gif-item';
                gifItem.innerHTML = `<img src="${gifUrl}" alt="GIF رومانسي">`;
                gifItem.addEventListener('click', function() { sendGif(gifUrl); });
                gifGrid.appendChild(gifItem);
            });
        }

        function sendGif(gifUrl) {
            db.collection('messages').add({
                text: '',
                senderId: currentUser.id,
                senderName: currentUser.name,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                gifUrl: gifUrl,
                reactions: {}
            });
            
            gifPicker.style.display = 'none';
            playSound('send'); // صوت send للـ GIF
            createBubbles(2);
        }

        // 🎯 إدارة النقرات
        document.addEventListener('click', function(e) {
            if (!emojiBtn.contains(e.target) && !emojiPicker.contains(e.target)) {
                emojiPicker.style.display = 'none';
            }
            
            if (!gifBtn.contains(e.target) && !gifPicker.contains(e.target)) {
                gifPicker.style.display = 'none';
            }
            
            if (!attachBtn.contains(e.target) && !fileUploadContainer.contains(e.target)) {
                fileUploadContainer.style.display = 'none';
            }
            
            if (!themeBtn.contains(e.target) && !themeOptions.contains(e.target)) {
                themeOptions.style.display = 'none';
            }
            
            if (!e.target.closest('.message-action') && !e.target.closest('.reaction-picker')) {
                document.querySelectorAll('.reaction-picker').forEach(function(picker) {
                    picker.style.display = 'none';
                });
            }
            
            if (window.innerWidth <= 768 && !e.target.closest('.users-sidebar') && !e.target.closest('.mobile-users-toggle')) {
                usersSidebar.classList.remove('active');
            }
        });

        // ⌨️ معالجة الأحداث
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        attachBtn.addEventListener('click', function(e) {
            fileUploadContainer.style.display = fileUploadContainer.style.display === 'block' ? 'none' : 'block';
            emojiPicker.style.display = 'none';
            gifPicker.style.display = 'none';
        });

        emojiBtn.addEventListener('click', function(e) {
            emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
            gifPicker.style.display = 'none';
            fileUploadContainer.style.display = 'none';
        });

        closePreview.addEventListener('click', closeFilePreview);
        cancelFileBtn.addEventListener('click', closeFilePreview);

        // 🚀 تهيئة التطبيق
        window.addEventListener('load', function() {
            // إضافة رسائل ترحيبية إذا لم تكن هناك رسائل
            setTimeout(function() {
                if (messages.length === 0) {
                    db.collection('messages').add({
                        text: 'مرحباً بك في شات الحب! 💖',
                        senderId: 'user1',
                        senderName: 'أحمد',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        reactions: {}
                    });
                }
            }, 2000);
        });
    </script>
</body>
</html>