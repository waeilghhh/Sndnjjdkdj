<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ğŸš ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø§ÙÙ„Ø© - Ø³Ø§Ø¦Ù‚</title>
<style>
body { font-family: sans-serif; margin:0; padding:0; background:#f5f5f5; text-align:center; }
header { background:#2c3e50; color:white; padding:15px; font-size:20px; }
section { margin:20px; }
button { padding:10px 20px; font-size:16px; margin:5px; cursor:pointer; }
#status { margin-top:10px; font-weight:bold; }
</style>
</head>
<body>
<header>ğŸš ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</header>
<section>
  <p>Ø§Ù„Ø­Ø§ÙÙ„Ø©: <span id="busIdDisplay">BUS_001</span></p>
  <button id="startBtn">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹</button>
  <button id="stopBtn">â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹</button>
  <div id="status">â³ Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØªØ¨Ø¹ Ø¨Ø¹Ø¯</div>
  <div id="info"></div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD6SOlFVTFs_goOPGlVzOb9puUCejNRASs",
  authDomain: "bustraker-41746.firebaseapp.com",
  databaseURL: "https://bustraker-41746-default-rtdb.firebaseio.com",
  projectId: "bustraker-41746",
  storageBucket: "bustraker-41746.appspot.com",
  messagingSenderId: "827170090699",
  appId: "1:827170090699:web:c23bb90c6ce8739435f54e",
  measurementId: "G-FJ1LXTLL9Z"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const busId = "BUS_001";
document.getElementById("busIdDisplay").innerText = busId;

let watchId = null;
let lastPos = null;
let lastTime = null;

const statusDiv = document.getElementById("status");
const infoDiv = document.getElementById("info");

function haversine(lat1, lon1, lat2, lon2){
  const R=6371000; // Ø¨Ø§Ù„Ø£Ù…ØªØ§Ø±
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); // Ø¨Ø§Ù„Ù…ØªØ±
}

function startTracking() {
  if(!navigator.geolocation){ statusDiv.innerText="âŒ GPS ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…"; return; }

  watchId = navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const timeNow = Date.now();

    let speedCalc = 0, distance = 0;
    if(lastPos){
      distance = haversine(lastPos.lat,lastPos.lng,lat,lng);
      const deltaTime = (timeNow - lastTime)/1000;
      speedCalc = deltaTime>0? distance/deltaTime : 0;
    }
    lastPos = {lat,lng};
    lastTime = timeNow;

    statusDiv.innerText = "ğŸ“¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø«: " + new Date().toLocaleTimeString();
    infoDiv.innerHTML = `Ø³Ø±Ø¹Ø©: ${(speedCalc*3.6).toFixed(1)} ÙƒÙ…/Ø³<br>Ù…Ø³Ø§ÙØ© Ù…Ù†Ø° Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${distance.toFixed(1)} Ù…`;

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Firebase
    set(ref(db,"buses/"+busId),{
      lat,lng,speed:speedCalc,distance,time: new Date().toLocaleTimeString()
    });

  }, err => {
    if(err.code === err.PERMISSION_DENIED) statusDiv.innerText = "âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹";
    else statusDiv.innerText = "âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: " + err.message;
  }, { enableHighAccuracy:true, maximumAge:0, timeout:10000 });
}

function stopTracking(){
  if(watchId!==null) navigator.geolocation.clearWatch(watchId);
  statusDiv.innerText = "â¹ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹";
}

document.getElementById("startBtn").addEventListener("click", startTracking);
document.getElementById("stopBtn").addEventListener("click", stopTracking);
</script>
</body>
</html>